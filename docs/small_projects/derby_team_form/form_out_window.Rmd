---
title: "Football Cliches: Derbies & Form"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Introduction

"Form goes out of the windows for a derby," is one of football's many cliches. But how does this map to reality? 

I thought I would have to go web scrape results to begin finding out, but luckily James Curly's engsoccerdata library already has a lot. Its data sets cover a number of European leagues, but the above cliche is - as far as I know - distinctly English, so I'll stick to that area of the football landscape.

## Libraries

```{r}
library(tidyverse)
library(engsoccerdata)
library(fuzzyjoin)
```

## Functions

```{r}
source("helper_functions.R")
```

## Imports

I got data on rilvaries the old-fashioned way: copy-pasting data from [Wikipedia](https://en.wikipedia.org/wiki/List_of_sports_rivalries_in_the_United_Kingdom#Association_Football) into a spreadsheet. Some cleaning in Excel (don't judge) created a pretty clean data set of 88 English rivalries to work with.

```{r}
#data(package="engsoccerdata")
eng_results <- england
eng_rivalries <- read_csv('eng_rivalries.csv')
eng_results <- eng_results %>% arrange(Date)

eng_results
eng_rivalries
```

## Processing

Equalizing differences in team names between the results and rivalries data sets took some fuzzy matching to acheive.

```{r}
eng_rivalries$teams_identifier <- paste(eng_rivalries$team1, eng_rivalries$team2)
eng_results$teams_identifier <- paste(eng_results$home, eng_results$visitor)

eng_results_rivalries <-eng_results %>%
  stringdist_left_join(eng_rivalries, by = c('teams_identifier'), max_dist = 1)
```

That gave me 51 matches out of my 88 rivalries, I played around with the parameters but my results didn't drastically improve.

```{r}
# -1 removes NA from the mask
rivalry_matches <- eng_rivalries[unique(eng_results_rivalries$rivalry_id)[-1], ] 
rivalry_matches
```

## Analysis

Before I march on, some methodology notes:

* I define form as the number (and relative number) of points collected in the team's five games prior to the derby.

* No calculations will depend on home field advantage.

```{r}
derbies <- derbies %>% 
  bind_cols(
    map_df(rilvary_indices, calculate_form, data = eng_with_rivalries, team = rilvary[1]),
    map_df(rilvary_indices, calculate_form, data = eng_with_rivalries, team = rilvary[2])
  ) %>%
  mutate(
  result_team = ifelse(
    result == 'H', 
    home,
    ifelse(result == 'A', visitor, 'Draw')
    )
) %>%
  mutate(
  better_form = ifelse(
    form > form1, 
    club,
    ifelse(form < form1, club1, 'Equal')
    )
)
```

**Abstracting away everything, but the code below should work mostly unchanged. Once I fix the compute_derby_df function, derbies will be a list of every derby I have along with the form of each team.**

```{r}
#Raw winner results and also by home/away

derbies %>% 
  count(result_team) %>%
  mutate(freq = round(n/sum(n), 2))

derbies %>% 
  count(result_team, result) %>%
  mutate(freq = round(n/sum(n), 2))
```

*So Wolves historically have been the better team having won 41% of the meetings between the two sides. A more granular break down shows that while the percentage of wins is similar for both teams at home (26% v 25%), it's Wolves' great away form that is the biggest difference (15% v 10%). That's not the question to answer though. How this breaks down by form?*

```{r}
form_ratios <- data.frame(prop.table(table(derbies$better_form, derbies$result_team)))
colnames(form_ratios) <- c('form_team', 'derby_winner', 'relative_occurence')
form_ratios$relative_occurence <- round(form_ratios$relative_occurence, 2)

form_ratios
```

*Beside the granular breakdown is the absolute answer. The form team coming into the derby won 32% of the time, while the out of form team won 34% of derby games. What about by location?*

```{r}
form_ratios_loc <- data.frame(prop.table(table(derbies$better_form, derbies$result_team, derbies$result)))
colnames(form_ratios_loc) <- c('form_team', 'derby_winner', 'derby_winner_location', 'relative_occurence')
form_ratios_loc$relative_occurence <- round(form_ratios_loc$relative_occurence, 2)

form_ratios_loc %>% 
  filter(relative_occurence > 0) %>%
  arrange(desc(relative_occurence))

form_ratios_loc %>% 
  filter(as.character(form_team) ==  as.character(derby_winner)) %>% 
  group_by(derby_winner_location) %>%
  summarise(total_rel_occur = sum(relative_occurence))

form_ratios_loc %>% 
  filter(
    form_team != 'Equal',
    derby_winner != 'Draw', 
    as.character(form_team) !=  as.character(derby_winner)
    ) %>% 
  group_by(derby_winner_location) %>%
  summarise(total_rel_occur = sum(relative_occurence))
```

## Visualization

Find way to visualize all the data well.

